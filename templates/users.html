# ==============================================================================
#  ZBH LICENSE SYSTEM | ULTIMATE PRO EDITION
#  Developed for: Orhan Aga
#  Version: 3.0 (PostgreSQL + Discord + Anti-Spam + Mobile Support)
# ==============================================================================

import os
import time
import uuid
import datetime
import logging
import requests
import psycopg2
from psycopg2.extras import RealDictCursor
from flask import Flask, render_template, request, jsonify, redirect, url_for, session
from functools import wraps
from dotenv import load_dotenv

# ------------------------------------------------------------------------------
# 1. KONFÄ°GÃœRASYON VE GÃœVENLÄ°K AYARLARI
# ------------------------------------------------------------------------------

# .env dosyasÄ±ndaki gizli ÅŸifreleri yÃ¼kle
load_dotenv()

# Flask UygulamasÄ±nÄ± BaÅŸlat
app = Flask(__name__)

# --- ORTAM DEÄžÄ°ÅžKENLERÄ° (ENVIRONMENT VARIABLES) ---
# EÄŸer .env dosyasÄ±nda bulamazsa varsayÄ±lan deÄŸerleri kullanÄ±r (GÃ¼venlik iÃ§in deÄŸiÅŸtirin!)
app.secret_key = os.getenv('SECRET_KEY', 'zbh_root_key_v3_ultra_secure_999')

# Admin GiriÅŸ Bilgileri (Render Environment kÄ±smÄ±ndan deÄŸiÅŸtirilmesi Ã¶nerilir)
ADMIN_USER = os.getenv('ADMIN_USER', 'admin') 
ADMIN_PASS = os.getenv('ADMIN_PASS', 'admin123') 

# DÄ±ÅŸ BaÄŸlantÄ±lar
DISCORD_WEBHOOK = os.getenv('DISCORD_WEBHOOK', '') # Discord Webhook URL
DATABASE_URL = os.getenv('DATABASE_URL') # PostgreSQL BaÄŸlantÄ± Linki

# --- GÃœVENLÄ°K SABÄ°TLERÄ° (CONSTANTS) ---
BLOCK_TIME = 600       # Saniye cinsinden IP ban sÃ¼resi (10 Dakika)
MAX_ATTEMPTS = 5       # Bir IP'nin hata yapma hakkÄ±
IS_LOCKDOWN = False    # Acil Durum Kilidi (Panic Mode) - BaÅŸlangÄ±Ã§ta KapalÄ±

# --- RAM ÃœZERÄ°NDE GEÃ‡Ä°CÄ° VERÄ° TUTUCULAR ---
# failed_attempts yapÄ±sÄ±: { 'IP_ADRESI': [Hata_Sayisi, Ilk_Hata_Zamani] }
failed_attempts = {} 

# Loglama AyarlarÄ± (Konsola basar)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# ==============================================================================
# 2. VERÄ°TABANI KATMANI (DATABASE LAYER)
# ==============================================================================

def get_db_connection():
    """
    PostgreSQL veritabanÄ±na gÃ¼venli bir baÄŸlantÄ± aÃ§ar.
    Hata durumunda None dÃ¶ner ve log basar.
    """
    if not DATABASE_URL:
        logger.error("KRÄ°TÄ°K HATA: DATABASE_URL bulunamadÄ±! Render ayarlarÄ±nÄ± kontrol et.")
        return None
    
    try:
        conn = psycopg2.connect(DATABASE_URL, sslmode='require')
        return conn
    except psycopg2.Error as e:
        logger.error(f"VeritabanÄ± BaÄŸlantÄ± HatasÄ±: {e}")
        return None

def init_db():
    """
    Sunucu ilk aÃ§Ä±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r.
    Gerekli tablolar (keys, mapping, logs) veritabanÄ±nda yoksa oluÅŸturur.
    Bu iÅŸlem 'Migration' mantÄ±ÄŸÄ±yla Ã§alÄ±ÅŸÄ±r.
    """
    logger.info("VeritabanÄ± tablolarÄ± kontrol ediliyor...")
    
    conn = get_db_connection()
    if not conn:
        logger.critical("VeritabanÄ±na baÄŸlanÄ±lamadÄ±! Tablolar oluÅŸturulamÄ±yor.")
        return

    try:
        cur = conn.cursor()
        
        # 1. KEYS TABLOSU: KullanÄ±cÄ± anahtarlarÄ±nÄ± tutar
        cur.execute('''
            CREATE TABLE IF NOT EXISTS keys (
                key_code VARCHAR(100) PRIMARY KEY,
                hwid VARCHAR(255),
                status VARCHAR(20) DEFAULT 'active',
                expires_at TIMESTAMP,
                type VARCHAR(20) DEFAULT 'Standard',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                ip_address VARCHAR(50)
            );
        ''')
        
        # 2. MAPPING TABLOSU: Oyun ID'si ile Script URL'sini eÅŸleÅŸtirir
        cur.execute('''
            CREATE TABLE IF NOT EXISTS mapping (
                id SERIAL PRIMARY KEY,
                game_name VARCHAR(100),
                place_id VARCHAR(50),
                script_url TEXT
            );
        ''')
        
        # 3. AUDIT LOGS TABLOSU: Sistemdeki tÃ¼m hareketleri kaydeder
        cur.execute('''
            CREATE TABLE IF NOT EXISTS audit_logs (
                id SERIAL PRIMARY KEY,
                action VARCHAR(50),
                details TEXT,
                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        ''')
        
        conn.commit()
        cur.close()
        conn.close()
        logger.info("âœ… VeritabanÄ± tablolarÄ± baÅŸarÄ±yla hazÄ±rlandÄ±.")
        
    except Exception as e:
        logger.error(f"Tablo OluÅŸturma HatasÄ± (Init DB): {e}")

# Uygulama baÅŸlarken veritabanÄ±nÄ± baÅŸlat
init_db()

# ==============================================================================
# 3. YARDIMCI SERVÄ°SLER (SERVICES)
# ==============================================================================

def log_action(action, details, notify_discord=False, color=0x00ff00):
    """
    Sistemdeki Ã¶nemli olaylarÄ± kaydeder.
    
    Args:
        action (str): OlayÄ±n kÄ±sa adÄ± (Ã¶rn: LOGIN_SUCCESS)
        details (str): OlayÄ±n detayÄ±
        notify_discord (bool): True ise Discord'a mesaj atar.
        color (hex): Discord embed rengi.
    """
    # 1. VeritabanÄ±na Yaz
    try:
        conn = get_db_connection()
        if conn:
            cur = conn.cursor()
            cur.execute("INSERT INTO audit_logs (action, details) VALUES (%s, %s)", (action, details))
            conn.commit()
            cur.close()
            conn.close()
    except Exception as e:
        logger.error(f"DB Log HatasÄ±: {e}")

    # 2. Discord'a GÃ¶nder (Webhook varsa)
    if notify_discord and DISCORD_WEBHOOK:
        payload = {
            "embeds": [{
                "title": f"ðŸ›¡ï¸ ZBH SYSTEM | {action}",
                "description": details,
                "color": color,
                "footer": {"text": "ZBH Security Protocol v3.0"},
                "timestamp": datetime.datetime.now().isoformat()
            }]
        }
        try:
            requests.post(DISCORD_WEBHOOK, json=payload, timeout=3)
        except requests.exceptions.RequestException as e:
            logger.warning(f"Discord Webhook HatasÄ±: {e}")

def login_required(f):
    """
    Flask Decorator: KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸsa login sayfasÄ±na yÃ¶nlendirir.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'logged_in' not in session:
            # Oturum yoksa, login sayfasÄ±na git
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

# ==============================================================================
# 4. WEB ARAYÃœZÃœ ROTALARI (FRONTEND ROUTES)
# ==============================================================================

@app.route('/')
def index():
    """Ana Sayfa: GiriÅŸ yapmÄ±ÅŸsa Dashboard'a, yapmamÄ±ÅŸsa Login'e atar."""
    if 'logged_in' in session:
        return redirect(url_for('dashboard'))
    else:
        return redirect(url_for('login'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    """GiriÅŸ SayfasÄ± Ä°ÅŸlemleri"""
    error = None
    if request.method == 'POST':
        user_ip = request.remote_addr
        username = request.form.get('username')
        password = request.form.get('password')
        
        # Admin DoÄŸrulama
        if username == ADMIN_USER and password == ADMIN_PASS:
            session['logged_in'] = True
            log_action("ADMIN_LOGIN", f"YÃ¶netici giriÅŸi yapÄ±ldÄ±. IP: {user_ip}", True, 0x00FF00)
            return redirect(url_for('dashboard'))
        else:
            log_action("FAILED_LOGIN", f"HatalÄ± giriÅŸ denemesi! IP: {user_ip}", True, 0xFF0000)
            error = "HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre Aga!"
            
    return render_template('login.html', error=error)

@app.route('/logout')
def logout():
    """Oturumu KapatÄ±r"""
    session.clear()
    return redirect(url_for('login'))

@app.route('/dashboard')
@login_required
def dashboard():
    """Ana Kontrol Paneli (Dashboard)"""
    conn = get_db_connection()
    if not conn: return "VeritabanÄ± HatasÄ±!", 500
    
    cur = conn.cursor()
    
    # Ä°statistikleri Topla
    stats = {'total': 0, 'active': 0, 'vip': 0, 'banned': 0}
    try:
        cur.execute("SELECT COUNT(*) FROM keys")
        stats['total'] = cur.fetchone()[0]
        
        cur.execute("SELECT COUNT(*) FROM keys WHERE status='active'")
        stats['active'] = cur.fetchone()[0]
        
        cur.execute("SELECT COUNT(*) FROM keys WHERE type='VIP'")
        stats['vip'] = cur.fetchone()[0]
        
        cur.execute("SELECT COUNT(*) FROM keys WHERE status='banned'")
        stats['banned'] = cur.fetchone()[0]
    except Exception as e:
        logger.error(f"Dashboard Ä°statistik HatasÄ±: {e}")
    finally:
        cur.close()
        conn.close()
    
    return render_template('dashboard.html', 
                         total=stats['total'], 
                         active=stats['active'], 
                         vip=stats['vip'], 
                         banned=stats['banned'], 
                         active_page='dashboard')

@app.route('/users')
@login_required
def users():
    """KullanÄ±cÄ± Listesi ve YÃ¶netimi"""
    conn = get_db_connection()
    if not conn: return "DB Error", 500
    
    # RealDictCursor ile verileri {key: value} formatÄ±nda Ã§ekeriz
    cur = conn.cursor(cursor_factory=RealDictCursor)
    cur.execute("SELECT * FROM keys ORDER BY created_at DESC")
    keys = cur.fetchall()
    
    cur.close()
    conn.close()
    return render_template('users.html', keys=keys, active_page='users')

@app.route('/mapping')
@login_required
def mapping():
    """Oyun ve Script EÅŸleÅŸtirme SayfasÄ±"""
    conn = get_db_connection()
    cur = conn.cursor(cursor_factory=RealDictCursor)
    cur.execute("SELECT * FROM mapping ORDER BY id DESC")
    mappings = cur.fetchall()
    cur.close()
    conn.close()
    return render_template('mapping.html', mappings=mappings, active_page='mapping')

@app.route('/audit-logs')
@login_required
def audit_logs():
    """Sistem LoglarÄ±nÄ± GÃ¶rÃ¼ntÃ¼leme"""
    conn = get_db_connection()
    cur = conn.cursor(cursor_factory=RealDictCursor)
    cur.execute("SELECT * FROM audit_logs ORDER BY id DESC LIMIT 100")
    logs = cur.fetchall()
    cur.close()
    conn.close()
    return render_template('audit_logs.html', logs=logs, active_page='audit_logs')

@app.route('/settings')
@login_required
def settings():
    """Ayarlar SayfasÄ±"""
    return render_template('settings.html', active_page='settings')

# ==============================================================================
# 5. API SÄ°STEMÄ° (ROBLOX SCRIPT & AJAX REQUESTS)
# ==============================================================================

@app.route('/api/verify', methods=['GET'])
def verify():
    """
    Roblox Script'inin baÄŸlandÄ±ÄŸÄ± ana doÄŸrulama noktasÄ±.
    Rate Limit ve Panic Mode korumasÄ± iÃ§erir.
    """
    global IS_LOCKDOWN
    client_ip = request.remote_addr
    
    # [1] PANIC MODE KONTROLÃœ
    if IS_LOCKDOWN:
        return jsonify({"status": "error", "msg": "SYSTEM_LOCKDOWN_ACTIVE"})

    # [2] ANTI-SPAM (RATE LIMITING) MEKANÄ°ZMASI
    current_time = time.time()
    
    # IP daha Ã¶nce hata yaptÄ±ysa kontrol et
    if client_ip in failed_attempts:
        attempts, first_time = failed_attempts[client_ip]
        
        # EÄŸer hata sÄ±nÄ±rÄ± aÅŸÄ±ldÄ±ysa
        if attempts >= MAX_ATTEMPTS:
            elapsed_time = current_time - first_time
            # SÃ¼re dolmadÄ±ysa engelle
            if elapsed_time < BLOCK_TIME:
                remaining_time = int(BLOCK_TIME - elapsed_time)
                return jsonify({
                    "status": "error", 
                    "msg": f"BLOCKED: Too Many Requests. Wait {remaining_time}s"
                })
            else:
                # SÃ¼re dolduysa affet ve listeden sil
                del failed_attempts[client_ip]

    # [3] GÄ°RÄ°Åž PARAMETRELERÄ°NÄ° AL
    key = request.args.get('key')
    hwid = request.args.get('hwid')
    place_id = request.args.get('placeid')

    # Parametre eksikse reddet
    if not key: 
        return jsonify({"status": "error", "msg": "MISSING_KEY_PARAMETER"})

    # [4] VERÄ°TABANI SORGUSU
    conn = get_db_connection()
    if not conn: return jsonify({"status": "error", "msg": "SERVER_DB_ERROR"})
    
    cur = conn.cursor(cursor_factory=RealDictCursor)
    
    # Key'i ara (SQL Injection korumalÄ±)
    cur.execute("SELECT * FROM keys WHERE key_code = %s", (key,))
    user = cur.fetchone()
    
    response = {"status": "error", "msg": "INVALID_KEY"}
    
    # KullanÄ±cÄ± var mÄ±?
    if user:
        # A. KullanÄ±cÄ± BanlÄ± mÄ±?
        if user['status'] == 'banned':
            response['msg'] = "ACCOUNT_BANNED"
            
        # B. Ä°lk GiriÅŸ mi? (HWID BoÅŸsa)
        elif not user['hwid']:
            # HWID'yi ve IP'yi kaydet (Binding)
            update_cur = conn.cursor()
            update_cur.execute(
                "UPDATE keys SET hwid = %s, ip_address = %s WHERE key_code = %s", 
                (hwid, client_ip, key)
            )
            conn.commit()
            update_cur.close()
            
            response = {"status": "success", "type": user['type']}
            log_action("KEY_BOUND", f"Key: {key} bound to HWID: {hwid}", True, 0x00FFFF)
            
        # C. HWID EÅŸleÅŸiyor mu?
        elif user['hwid'] != hwid:
            response['msg'] = "HWID_MISMATCH"
            
            # HatalÄ± giriÅŸ sayÄ±sÄ±nÄ± artÄ±r
            if client_ip not in failed_attempts:
                failed_attempts[client_ip] = [1, current_time]
            else:
                failed_attempts[client_ip][0] += 1
                
            log_action("SECURITY_ALERT", f"HWID UyuÅŸmazlÄ±ÄŸÄ±! Key: {key} IP: {client_ip}", True, 0xFF0000)
            
        # D. Her Åžey Yolunda
        else:
            response = {"status": "success", "type": user['type']}
            
            # Son IP adresini gÃ¼ncelle
            ip_cur = conn.cursor()
            ip_cur.execute("UPDATE keys SET ip_address = %s WHERE key_code = %s", (client_ip, key))
            conn.commit()
            ip_cur.close()

    # [5] SCRIPT URL GÃ–NDERME (EÄŸer giriÅŸ baÅŸarÄ±lÄ±ysa)
    if response['status'] == 'success':
        # BaÅŸarÄ±lÄ± olduÄŸu iÃ§in ceza listesinden Ã§Ä±kar
        if client_ip in failed_attempts: 
            del failed_attempts[client_ip]
            
        # Oyun ID'sine gÃ¶re scripti bul
        cur.execute("SELECT script_url FROM mapping WHERE place_id = %s", (place_id,))
        mapping_row = cur.fetchone()
        
        response['script_url'] = mapping_row['script_url'] if mapping_row else ""
        
        # Ä°steÄŸe baÄŸlÄ±: VIP giriÅŸlerini detaylÄ± logla
        if user and user['type'] == 'VIP':
            pass # DB ÅŸiÅŸmesin diye kapalÄ±, aÃ§mak iÃ§in: log_action(...)

    cur.close()
    conn.close()
    return jsonify(response)

# --- KEY OLUÅžTURMA (GENERATE KEY) ---
@app.route('/api/generate_key', methods=['POST'])
@login_required
def generate_key():
    """Yeni bir lisans anahtarÄ± Ã¼retir ve veritabanÄ±na kaydeder."""
    try:
        data = request.json
        duration = data.get('duration')
        is_vip = data.get('is_vip')
        
        # SÃ¼re hesaplama
        days = 3650 if duration == 'lifetime' else (30 if duration == '30_day' else 7)
        expires_at = datetime.datetime.now() + datetime.timedelta(days=days)
        
        # Benzersiz Anahtar Ãœretimi
        prefix = "ZBH-VIP" if is_vip else "ZBH-GEN"
        unique_str = str(uuid.uuid4())[:8].upper()
        key_code = f"{prefix}-{unique_str}"
        
        # DB KayÄ±t
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute(
            "INSERT INTO keys (key_code, status, expires_at, type, created_at) VALUES (%s, %s, %s, %s, NOW())",
            (key_code, 'active', expires_at, 'VIP' if is_vip else 'Standard')
        )
        conn.commit()
        cur.close()
        conn.close()
        
        log_action("KEY_GENERATED", f"Yeni Anahtar: {key_code} ({duration})", True, 0x00FF00)
        return jsonify({"success": True})
        
    except Exception as e:
        logger.error(f"Key Gen HatasÄ±: {e}")
        return jsonify({"success": False, "msg": str(e)})

# --- HWID SIFIRLAMA (RESET) ---
@app.route('/api/reset_hwid', methods=['POST'])
@login_required
def reset_hwid():
    """KullanÄ±cÄ±nÄ±n kilitli olduÄŸu cihazÄ± (HWID) sÄ±fÄ±rlar."""
    try:
        data = request.json
        key = data.get('key')
        
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("UPDATE keys SET hwid = NULL WHERE key_code = %s", (key,))
        conn.commit()
        cur.close()
        conn.close()
        
        log_action("HWID_RESET", f"HWID SÄ±fÄ±rlandÄ±: {key}", True, 0xFFA500)
        return jsonify({"success": True})
    except Exception as e:
        return jsonify({"success": False, "msg": str(e)})

# --- KULLANICI BANLAMA ---
@app.route('/api/ban_user', methods=['POST'])
@login_required
def ban_user():
    """KullanÄ±cÄ±yÄ± sÃ¼resiz banlar."""
    try:
        data = request.json
        key = data.get('key')
        
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("UPDATE keys SET status = 'banned' WHERE key_code = %s", (key,))
        conn.commit()
        cur.close()
        conn.close()
        
        log_action("USER_BANNED", f"KullanÄ±cÄ± BanlandÄ±: {key}", True, 0xFF0000)
        return jsonify({"success": True})
    except Exception as e:
        return jsonify({"success": False, "msg": str(e)})

# --- KULLANICI SÄ°LME ---
@app.route('/api/delete_user', methods=['POST'])
@login_required
def delete_user():
    """KullanÄ±cÄ±yÄ± veritabanÄ±ndan tamamen siler."""
    try:
        data = request.json
        key = data.get('key')
        
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("DELETE FROM keys WHERE key_code = %s", (key,))
        conn.commit()
        cur.close()
        conn.close()
        
        log_action("USER_DELETED", f"KullanÄ±cÄ± Silindi: {key}", False)
        return jsonify({"success": True})
    except Exception as e:
        return jsonify({"success": False, "msg": str(e)})

# --- MAPPING EKLEME ---
@app.route('/api/add_mapping', methods=['POST'])
@login_required
def add_mapping():
    """Yeni oyun-script eÅŸleÅŸtirmesi ekler."""
    try:
        data = request.json
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute(
            "INSERT INTO mapping (game_name, place_id, script_url) VALUES (%s, %s, %s)", 
            (data['game_name'], data['place_id'], data['script_url'])
        )
        conn.commit()
        cur.close()
        conn.close()
        return jsonify({"success": True})
    except Exception as e:
        return jsonify({"success": False, "msg": str(e)})

# --- MAPPING SÄ°LME ---
@app.route('/api/delete_mapping', methods=['POST'])
@login_required
def delete_mapping():
    """Oyun-script eÅŸleÅŸtirmesini siler."""
    try:
        data = request.json
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute("DELETE FROM mapping WHERE id = %s", (data['id'],))
        conn.commit()
        cur.close()
        conn.close()
        return jsonify({"success": True})
    except Exception as e:
        return jsonify({"success": False, "msg": str(e)})

# --- PANIC MODE (SÄ°STEM KÄ°LÄ°TLEME) ---
@app.route('/api/panic_toggle', methods=['POST'])
@login_required
def panic_toggle():
    """TÃ¼m sistemi anÄ±nda kilitler veya aÃ§ar."""
    global IS_LOCKDOWN
    data = request.json
    
    if 'state' in data: 
        IS_LOCKDOWN = data['state']
    else: 
        IS_LOCKDOWN = not IS_LOCKDOWN
    
    log_action("PANIC_MODE", f"Sistem Kilidi Durumu: {IS_LOCKDOWN}", True, 0xFF0000)
    return jsonify({"success": True, "state": IS_LOCKDOWN})

# --- HEARTBEAT (UPTIME MONITOR) ---
@app.route('/api/heartbeat')
def heartbeat():
    """UptimeRobot gibi servisler iÃ§in canlÄ±lÄ±k sinyali."""
    return jsonify({
        "status": "alive", 
        "online": True,
        "timestamp": time.time()
    })

# ==============================================================================
# 6. SUNUCU BAÅžLATMA (ENTRY POINT)
# ==============================================================================

if __name__ == '__main__':
    # Render tarafÄ±ndan atanan portu al, yoksa 5000 kullan
    port = int(os.environ.get("PORT", 5000))
    
    # UygulamayÄ± baÅŸlat
    # Not: debug=True prodÃ¼ksiyon ortamÄ±nda risklidir, Render'da kapalÄ± kalmalÄ±.
    app.run(host='0.0.0.0', port=port)
